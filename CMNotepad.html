<!DOCTYPE html>
<html>
  <head>
    <title>HTML5 notepad app</title>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.45.0/codemirror.min.css"
      type="text/css"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.45.0/codemirror.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/localStorage/2.0.1/localStorage.min.js"
      type="text/javascript"
    ></script>
    <style type="text/css">
      html,
      body {
        background: #fcfcfc;
        color: #444;
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: relative;
      }
      #notepad {
        height: 100%;
        width: 100%;
        padding: 1%;
        font-size: 100%;
        line-height: 125%;
        font-family: san-serif;
        box-sizing: border-box;
      }
      .CodeMirror {
        height: 100vh;
        width: 100vw;
      }
      ::selection {
        background: #7d7;
      }
      ::-moz-selection {
        background: #7d7;
      }
      #config {
        background: #111;
        color: #ccc;
        font-family: sans-serif;
        margin:1rem;
        padding:1rem;
      }
      label {
        display: block;
        padding: 0.5rem;
      }
      label[for="settings"] {
        position: absolute;
        padding: 0;
        top: 0.5em;
        right: 0.5em;
        z-index: 9999;
      }
      #settings {
        position:absolute;
        left: -9999px;
      }
      #settings ~ #config {
          display: none;
          z-index: -1111;
      }
      #settings:checked ~ #config {
          display:inline-block;
          position: absolute;
          top: 0;
          right: 0;
          z-index: 8888;
      }
    </style>
  </head>
  <body>
    <input type="checkbox" id="settings" name="settings">
    <label for="settings"><img src="http://icons.iconarchive.com/icons/google/noto-emoji-objects/16/62971-gear-icon.png" alt="settings"/></label>
    <form id="config">
      <label>Keymap
          <select id="keyMap">
            <option>none</option>
            <option value="emacs">Emacs</option>
            <option value="vim">Vim</option>
            <option value="sublime">Sublime</option>
          </select>
      </label>
      <label>Line numbers
          <input type="checkbox" id="lineNumbers"/>
      </label>
      <input type="submit" value="save">
    </form>
    <script type="text/javascript">
      /* initialize CodeMirror */
      var CM = CodeMirror(document.body, {
        value: localStorage.getItem("CMNotepad") || "Type it here, see it here.",
        autofocus: true,
        viewportMargin: Infinity
      });


      /* handle settings */
      document.getElementById("config").addEventListener("submit", function (event) {
          event.preventDefault();
          // loop through everything in this form
          let configOptions =
            [].slice.call(event.target).map(function(data) { // create a 2d array of key/value pairs
              if (data.id) {
                if (data.type === "checkbox") {
                  return [data.id, data.checked];
                } else {
                  return [data.id, data.value];
                }
              } else {
                return null;
              }
            }).filter(function (data) { return data !== null }); // remove null(s)
          console.log(configOptions);
          // save options
          localStorage.setItem("CMNotepadOptions", JSON.stringify(configOptions));
          // apply options
          setCMOptions(configOptions);
          // hide form
          document.getElementById("settings").checked = false;
          return false;
      });

      /* themes */
      function setTheme(theme) {
        // clear previous theme
        var oldLink = document.getElementById(theme);
        if (oldLink) {
          oldLink.parentNode.removeChild(oldLink);
        }
        // apply theme
        var link = document.createElement('link');
        link.onload = function(){
              CM.setOption("theme", theme);
        };
        link.rel = "stylesheet";
        link.media = "all";
        link.id = theme;
        link.href = "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/theme/"+theme+".css";
        document.getElementsByTagName('head')[0].appendChild(link);
      }

      /* keymaps */
      function setKeymap(keymap) {
        // clear previous keymap
        var oldscript = document.getElementById(keymap);
        if (oldscript) {
          oldscript.parentNode.removeChild(oldscript);
        }
        // apply keymap
        var script = document.createElement('script');
        script.onload = function(){
              CM.setOption("keyMap", keymap);
        };
        script.id = keymap;
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/keymap/"+keymap+".min.js";
        document.getElementsByTagName('head')[0].appendChild(script);
      }

      /* apply & load settings */
      function setCMOptions (opts) {
        if (opts) {
          opts.forEach(function(opt) {
              if (opt[0] === "theme") {
                setTheme(opt[1]);
              } else if (opt[0] === "keyMap") {
                setKeymap(opt[1]);
              } else {
                CM.setOption(opt[0], opt[1]);
              }
              var el = document.getElementById(opt[0]);
              if (el.type == "checkbox") {
                el.checked = opt[1];
              } else {
                el.value = opt[1];
              }
            });
        }
      }
      setCMOptions(JSON.parse(localStorage.getItem("CMNotepadOptions")));

      /* save */
      var save = function() {
        localStorage.setItem("CMNotepad", CM.getValue());
      };
      /* autosave onchange and when you close the window */
      CM.on("change", save);
      window.onunload = save();
    </script>
  </body>
</html>
