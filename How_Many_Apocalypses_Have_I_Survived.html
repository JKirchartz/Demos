<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>How Many Apocalypses Have I Survived?</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
        <script src="http://js.cdn.tl/jquery-1.8.1.min.js"></script>
        <style>
            html, body {
                height:100%;width:100%;
                margin:0;
                padding:0;
            }
            body {
                font:100%/1.5 sans-serif;
                display: -webkit-box;
                -webkit-box-orient: horizontal;
                -webkit-box-pack: center;
                -webkit-box-align: center;

                display: -moz-box;
                -moz-box-orient: horizontal;
                -moz-box-pack: center;
                -moz-box-align: center;

                display: box;
                box-orient: horizontal;
                box-pack: center;
                box-align: center;
                text-align:center;
            }
            #main {
                max-width:90%;
            }
            #year, #submit {
                display:inline-block;
                font-size:2em;
                line-height:1.5;
            }
            #social {
                margin:1em;
            }
            h1 {font-size:2em}
            #result, #form {display:none}
            #result {margin-top:1em;}
        </style>
    </head>
    <body>
        <div id="main">
            <div id="loading">Loading<br/><img src="http://img.cdn.tl/loading20.gif" alt="" /></div>
            <form id="form" action="#">
                <h1>Find out how many times you've survived "the apocalypse"</h1>
                <input type="text" id="year" placeholder="Year of Birth"/><button type="submit" id="submit">&raquo;</button>
            </form>
            <div id="result">
                <h2>You have survived <span id="counter"></span> times.</h2>
                <table id="output">

                </table>
                <p>Find out more on <a href="https://en.wikipedia.org/wiki/List_of_dates_predicted_for_apocalyptic_events">wikipedia</a></p> 
                <div id="social">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://bit.ly/ZqUg4K" data-text="how many times have you survived the apocalypse?" data-via="JKirchartz" data-related="jkirchartz">Tweet</a>
                    <div class="fb-like" data-href="http://jkirchartz.com/demos/How_Many_Apocalypses_Have_I_Survived.html" data-send="false" data-width="450" data-show-faces="false"></div>
                </div>
            </div>
            <div id="fb-root"></div>
    <script>
        var getYears = [],
        getMeta = [],
        showMeta = [],
        count = 0,
        d = new Date(),
        currYear = d.getFullYear();
        $(function() {
                $.getJSON("http://en.wikipedia.org/w/api.php?action=parse&format=json&page=List_of_dates_predicted_for_apocalyptic_events&prop=wikitext&callback=?",
                    function(data) {
                    var chunks = data.parse.wikitext["*"].split("\n|-"),
                    holdYear = 0,
                    rowspan = 0;
                    for(var i = 0, l = chunks.length; i < l; i++){
                    var row = chunks[i].split("\n|");
                    row.shift();
                        if(row.length != 0){
                        var yr = row[0].match(/\d{4}/), rs = row[0].match(/rowspan="(\d)"/),year;
                             if(rs !== null && rs.length !== 0){
                                row.shift();
                                row.unshift(yr[0]);
                                holdYear = yr[0];
                                rowspan = rs[1];
                                console.log("##rowspan##",holdYear,rowspan);
                             }
                             if(yr!==null && yr.length!==0){
                                  year = yr[0];
                             }else{
                                  year = holdYear;
                                  row.unshift(holdYear);
                             }
                             if(year){
                                getYears.push([year,row]);
                             }
                             if(rowspan>0){
                                 rowspan--;
                             }else if(rowspan==0){
                                 holdYear = 0;
                             }
                        }
                        }
                        $("#loading").hide();
                        $("#form").show();
                    });
            });

        $("#form").on("submit", function(e) {
            e.preventDefault();
            var inputYear = parseInt($("#year").val(),10);
            if(!inputYear){
                $("#year").val("");
                alert("Try a number, genius.");
                return false;
            }
            getYears.map(function(item) {
                console.log(item);
                var yr = parseInt(item[0],10);
                if (yr !== null &&
                    (yr >= inputYear) &&
                    (yr <= currYear)
                ) {
                count++;
                showMeta.push(item[1]);
                    }
            });
            console.log(showMeta);
            var output = document.createElement("tbody");
            for (var i = 0, l = showMeta.length;i<l;i++){
                output.appendChild(showMeta[i]);
            }
            $("table#output").append(output);
            $("#counter").text(count);
            $("#result").show();
            count = 0;
            showMeta = [];
            return false;
            });
        (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
        fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
        !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>
</body>
</html>
